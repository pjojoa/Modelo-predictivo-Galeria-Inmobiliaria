<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoMapval Proyectos Inmobiliarios - Cali</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <!-- Leaflet Heat CSS (no hay CSS espec√≠fico, se incluye en JS) -->
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- CSS personalizado -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar-modern.css') }}">
    <!-- GeoMapval Chat Widget -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/geomapval-chat.css') }}">
</head>
<body>
    <!-- Backdrop del panel -->
    <div id="panelBackdrop" hidden aria-hidden="true"></div>
    
    <!-- Bot√≥n toggle flotante en la barra lateral izquierda - FUERA del panel para que siempre sea visible -->
    <button id="togglePanelBtn" class="sidebar-toggle-btn" aria-controls="sidebar" aria-expanded="false" aria-label="Expandir/Ocultar Panel de Control" title="Expandir Panel">
        <i class="fas fa-cog"></i>
    </button>
    
    <!-- Header -->
    <header class="main-header">
        <div class="container">
            <h1><i class="fas fa-map-marked-alt"></i> GeoMapval Proyectos Inmobiliarios</h1>
            <p><i class="fas fa-map-marker-alt"></i> Cali, Colombia</p>
        </div>
        <!-- Bot√≥n de informaci√≥n sobre clasificaci√≥n -->
        <button id="info-classification-btn" class="info-btn" aria-label="Informaci√≥n sobre clasificaci√≥n de proyectos" title="¬øC√≥mo se clasifican los proyectos?">
            <i class="fas fa-info-circle"></i>
        </button>
    </header>
    
    <!-- Modal de informaci√≥n sobre clasificaci√≥n -->
    <div id="classification-info-modal" class="info-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-hidden="true">
        <div class="info-modal-backdrop"></div>
        <div class="info-modal-content">
            <div class="info-modal-header">
                <h2 id="modal-title"><i class="fas fa-graduation-cap"></i> Sistema de Clasificaci√≥n de Proyectos</h2>
                <button class="info-modal-close" aria-label="Cerrar" title="Cerrar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="info-modal-body">
                <div class="info-section">
                    <h3><i class="fas fa-chart-line"></i> Descripci√≥n General</h3>
                    <p>El sistema clasifica autom√°ticamente los proyectos inmobiliarios en tres categor√≠as (<strong>Exitosos</strong>, <strong>Moderados</strong>, <strong>Mejorables</strong>) mediante un modelo de scoring multi-variable que eval√∫a m√∫ltiples m√©tricas de desempe√±o.</p>
                </div>
                
                <div class="info-section">
                    <h3><i class="fas fa-calculator"></i> M√©tricas Evaluadas</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-tachometer-alt"></i></div>
                            <div class="metric-info">
                                <h4>Velocidad de Ventas (30%)</h4>
                                <p>Meses para agotar inventario. Proyectos m√°s r√°pidos reciben mayor puntuaci√≥n.</p>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-chart-bar"></i></div>
                            <div class="metric-info">
                                <h4>Velocidad Hist√≥rica (18%)</h4>
                                <p>Unidades vendidas por mes. Eval√∫a el ritmo constante de ventas.</p>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-percentage"></i></div>
                            <div class="metric-info">
                                <h4>Porcentaje Vendido (12%)</h4>
                                <p>Penetraci√≥n en el mercado. Mayor porcentaje vendido = mejor score.</p>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-clock"></i></div>
                            <div class="metric-info">
                                <h4>Antig√ºedad y Eficiencia (10%)</h4>
                                <p>Eficiencia temporal del proyecto. Proyectos m√°s antiguos con buen desempe√±o reciben penalizaci√≥n.</p>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-building"></i></div>
                            <div class="metric-info">
                                <h4>Tama√±o del Proyecto (7%)</h4>
                                <p>N√∫mero total de unidades. Proyectos de tama√±o √≥ptimo reciben mejor puntuaci√≥n.</p>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-dollar-sign"></i></div>
                            <div class="metric-info">
                                <h4>Precio por m¬≤ (7%)</h4>
                                <p>Posici√≥n competitiva del precio. Comparado con el percentil de la zona.</p>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-ruler-combined"></i></div>
                            <div class="metric-info">
                                <h4>√Årea Promedio (5%)</h4>
                                <p>√Årea promedio de las unidades. Tama√±os √≥ptimos reciben mejor puntuaci√≥n.</p>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-star"></i></div>
                            <div class="metric-info">
                                <h4>Caracter√≠sticas (4%)</h4>
                                <p>N√∫mero de alcobas, ba√±os y garajes. M√°s caracter√≠sticas = mejor score.</p>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-swimming-pool"></i></div>
                            <div class="metric-info">
                                <h4>Amenidades (3%)</h4>
                                <p>N√∫mero de amenidades disponibles. Proyectos con m√°s amenidades reciben mejor puntuaci√≥n.</p>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-chart-area"></i></div>
                            <div class="metric-info">
                                <h4>Patr√≥n de Ventas (2%)</h4>
                                <p>Patr√≥n de comportamiento de ventas (Acelerado, Constante, Desacelerado).</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="info-section">
                    <h3><i class="fas fa-trophy"></i> Categor√≠as de Clasificaci√≥n</h3>
                    <div class="classification-cards">
                        <div class="classification-card success">
                            <div class="classification-header">
                                <i class="fas fa-check-circle"></i>
                                <h4>Exitoso</h4>
                            </div>
                            <div class="classification-body">
                                <p><strong>Score:</strong> 0.62 - 0.79</p>
                                <p><strong>Caracter√≠sticas:</strong></p>
                                <ul>
                                    <li>Top 33% m√°s r√°pido en agotar inventario</li>
                                    <li>Alta velocidad de ventas</li>
                                    <li>Patr√≥n de ventas Acelerado o Constante</li>
                                    <li>Score compuesto ‚â• 0.67</li>
                                </ul>
                            </div>
                        </div>
                        <div class="classification-card moderate">
                            <div class="classification-header">
                                <i class="fas fa-exclamation-circle"></i>
                                <h4>Moderado</h4>
                            </div>
                            <div class="classification-body">
                                <p><strong>Score:</strong> 0.50 - 0.62</p>
                                <p><strong>Caracter√≠sticas:</strong></p>
                                <ul>
                                    <li>33%-67% en velocidad de ventas</li>
                                    <li>Desempe√±o promedio</li>
                                    <li>Patr√≥n de ventas Constante o Desacelerado</li>
                                    <li>Score compuesto 0.33 - 0.67</li>
                                </ul>
                            </div>
                        </div>
                        <div class="classification-card improve">
                            <div class="classification-header">
                                <i class="fas fa-times-circle"></i>
                                <h4>Mejorable</h4>
                            </div>
                            <div class="classification-body">
                                <p><strong>Score:</strong> 0.21 - 0.50</p>
                                <p><strong>Caracter√≠sticas:</strong></p>
                                <ul>
                                    <li>Bottom 33% en velocidad de ventas</li>
                                    <li>Baja velocidad de ventas</li>
                                    <li>Patr√≥n de ventas Desacelerado</li>
                                    <li>Score compuesto < 0.33</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="info-section">
                    <h3><i class="fas fa-cogs"></i> Proceso de Clasificaci√≥n</h3>
                    <ol class="process-steps">
                        <li>
                            <strong>Clasificaci√≥n por Segmentos:</strong> Los proyectos se agrupan por Zona + Estrato + Tipo_VIS para comparaci√≥n justa dentro del mismo segmento de mercado.
                        </li>
                        <li>
                            <strong>C√°lculo de Scores:</strong> Se calculan scores normalizados (0-1) para cada m√©trica evaluada.
                        </li>
                        <li>
                            <strong>Score Compuesto:</strong> Se combinan todos los scores con sus respectivos pesos para obtener un score final.
                        </li>
                        <li>
                            <strong>Clasificaci√≥n Final:</strong> Basado en el score compuesto, se asigna la categor√≠a correspondiente.
                        </li>
                        <li>
                            <strong>Ajuste de Score:</strong> El score final se ajusta para que coincida con los rangos esperados de cada categor√≠a.
                        </li>
                    </ol>
                </div>
                
                <div class="info-section">
                    <h3><i class="fas fa-lightbulb"></i> Notas Importantes</h3>
                    <ul class="notes-list">
                        <li>La clasificaci√≥n se realiza autom√°ticamente al cargar los datos desde <strong>Base Proyectos.xlsx</strong>.</li>
                        <li>El sistema garantiza que <strong>TODOS</strong> los proyectos tengan una clasificaci√≥n v√°lida (nunca "Sin Clasificar").</li>
                        <li>Si un proyecto no puede clasificarse por segmento, se usa el m√©todo global como fallback.</li>
                        <li>Los scores se normalizan para permitir comparaci√≥n justa entre proyectos de diferentes segmentos.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

        <!-- Sidebar de filtros y proyectos (off-canvas) - Fuera del contenedor para evitar problemas de overflow -->
        <aside class="sidebar" id="sidebar" role="dialog" aria-modal="true" aria-labelledby="sidebar-title" aria-hidden="true" tabindex="-1">
            <div class="sidebar-header">
                <h2 id="sidebar-title"><i class="fas fa-sliders-h"></i> <span class="sidebar-title">Panel de Control</span></h2>
                </div>
            
            <!-- Resize handle para redimensionar el panel -->
            <div class="sidebar-resize-handle" id="sidebar-resize-handle" title="Arrastra para redimensionar el ancho del panel">
                <i class="fas fa-grip-vertical"></i>
            </div>
            
            <div class="sidebar-content" id="sidebar-content">
                <!-- Pesta√±as del sidebar -->
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" data-tab="filtros" aria-label="Pesta√±a Filtros">
                        <i class="fas fa-filter"></i>
                        <span>Filtros</span>
                    </button>
                    <button class="sidebar-tab" data-tab="estadisticas" aria-label="Pesta√±a Estad√≠sticas y Categor√≠as">
                        <i class="fas fa-chart-pie"></i>
                        <span>Estad√≠sticas</span>
                    </button>
                </div>
                
                <!-- Contenido de pesta√±as -->
                <div class="sidebar-tab-content">
                    <!-- Pesta√±a: Filtros -->
                    <div class="tab-pane active" id="tab-filtros">
                <!-- B√∫squeda por nombre de Proyecto - PRIMERO -->
                <div class="filter-section">
                                <label for="proyecto_search" class="filter-label">
                                    <i class="fas fa-search"></i> Buscar Proyecto
                                </label>
                                <div class="search-input-modern">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="proyecto_search" class="search-input-control" placeholder="Escribe el nombre del proyecto...">
                                    <button id="proyecto_search_clear" class="search-clear-btn" title="Limpiar b√∫squeda" aria-label="Limpiar">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <small id="proyecto_search_info" class="search-info-text-modern">Filtra la tabla y el mapa por nombre.</small>
                </div>

            <div class="filter-section">
                            <label for="clasificacion" class="filter-label">
                                <i class="fas fa-tags"></i> Clasificaci√≥n
                            </label>
                            <select id="clasificacion" class="filter-select modern-select">
                    <option value="Todos">Todos</option>
                </select>
            </div>
            
            <div class="filter-section">
                            <label for="zona" class="filter-label">
                                <i class="fas fa-map-marked-alt"></i> Zona
                            </label>
                            <select id="zona" class="filter-select modern-select">
                    <option value="Todas">Todas</option>
                </select>
            </div>
            
            <div class="filter-section">
                            <label for="barrio" class="filter-label">
                                <i class="fas fa-map-marker-alt"></i> Barrio
                            </label>
                            <select id="barrio" class="filter-select modern-select">
                    <option value="Todos">Todos</option>
                </select>
            </div>
            
            <div class="filter-section">
                            <label for="tipo_vis" class="filter-label">
                                <i class="fas fa-home"></i> Tipo VIS
                            </label>
                            <select id="tipo_vis" class="filter-select modern-select">
                    <option value="Todos">Todos</option>
                </select>
            </div>
            
            <div class="filter-section">
                            <label for="estado" class="filter-label">
                                <i class="fas fa-toggle-on"></i> Estado del Proyecto
                            </label>
                            <select id="estado" class="filter-select modern-select">
                                <option value="Activos" selected>Activos</option>
                    <option value="Todos">Todos</option>
                    <option value="Inactivos">Inactivos</option>
                </select>
            </div>
            
            <div class="filter-section">
                            <label for="precio_range" class="filter-label">
                                <i class="fas fa-dollar-sign"></i> Rango de Precio (COP)
                            </label>
                            <div class="price-range-modern">
                                <div class="price-input-wrapper">
                                    <label for="precio_min" class="price-label-modern">M√≠nimo</label>
                                    <input type="number" id="precio_min" class="price-input-modern" placeholder="0" min="0" step="100000">
                                </div>
                                <div class="price-separator-modern">
                                    <i class="fas fa-arrows-alt-h"></i>
                                </div>
                                <div class="price-input-wrapper">
                                    <label for="precio_max" class="price-label-modern">M√°ximo</label>
                                    <input type="number" id="precio_max" class="price-input-modern" placeholder="‚àû" min="0" step="100000">
                                </div>
                            </div>
                            <div class="price-range-info-modern">
                                <small id="precio_range_info" class="price-info-text-modern">Rango completo disponible</small>
                            </div>
                            <div class="price-buttons-modern">
                                <button id="aplicar_precio" class="btn-apply-modern">
                                    <i class="fas fa-check"></i> Aplicar
                                </button>
                                <button id="limpiar_precio" class="btn-clear-modern">
                                    <i class="fas fa-times"></i> Limpiar
                                </button>
                            </div>
                </div>

                <!-- Rango de √Årea (m¬≤) con decimales -->
                <div class="filter-section">
                                <label for="area_range" class="filter-label">
                                    <i class="fas fa-ruler-combined"></i> Rango de √Årea (m¬≤)
                                </label>
                                <div class="area-range-modern">
                                    <div class="area-input-wrapper">
                                        <label for="area_min" class="area-label-modern">M√≠nimo</label>
                                        <input type="number" id="area_min" class="area-input-modern" placeholder="0.0" min="0" step="0.1" inputmode="decimal">
                                    </div>
                                    <div class="area-separator-modern">
                                        <i class="fas fa-arrows-alt-h"></i>
                                    </div>
                                    <div class="area-input-wrapper">
                                        <label for="area_max" class="area-label-modern">M√°ximo</label>
                                        <input type="number" id="area_max" class="area-input-modern" placeholder="‚àû" min="0" step="0.1" inputmode="decimal">
                                    </div>
                                </div>
                                <div class="area-range-info-modern">
                                    <small id="area_range_info" class="area-info-text-modern">Rango completo disponible</small>
                                </div>
                                <div class="area-buttons-modern">
                                    <button id="aplicar_area" class="btn-apply-modern">
                                        <i class="fas fa-check"></i> Aplicar
                                    </button>
                                    <button id="limpiar_area" class="btn-clear-modern">
                                        <i class="fas fa-times"></i> Limpiar
                                    </button>
                                </div>
                </div>
            </div>
            
                    <!-- Pesta√±a: Estad√≠sticas y Categor√≠as -->
                    <div class="tab-pane" id="tab-estadisticas">
                        <!-- Panel de Categor√≠as de Clasificaci√≥n (oculto cuando el criterio es "clasificacion") -->
                        <div class="categories-panel-sidebar" id="categories-panel-sidebar" style="display: none;">
                            <div class="categories-sidebar-header">
                                <div class="categories-sidebar-header-left">
                                    <i class="fas fa-layer-group"></i>
                                    <div class="categories-sidebar-header-text">
                                        <strong id="categories-panel-title">Filtrar Categor√≠as</strong>
                                        <span class="categories-sidebar-subtitle" id="categories-subtitle">Selecciona las categor√≠as a mostrar</span>
                                    </div>
                                </div>
                                <div class="categories-sidebar-header-actions">
                                    <button class="categories-sidebar-action-btn tooltip-trigger" id="categories-select-all" title="Seleccionar todas">
                                        <i class="fas fa-check-double"></i>
                                    </button>
                                    <button class="categories-sidebar-action-btn tooltip-trigger" id="categories-deselect-all" title="Deseleccionar todas">
                                        <i class="fas fa-times"></i>
                                    </button>
                </div>
                </div>
                            
                            <div class="categories-sidebar-content">
                                <div class="categories-search-box-sidebar">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="categories-search" class="categories-search-input-sidebar" placeholder="Buscar categor√≠a...">
                                    <button class="categories-search-clear-sidebar" id="categories-search-clear" style="display: none;">
                                        <i class="fas fa-times"></i>
                                    </button>
                </div>
                                
                                <div class="categories-list-sidebar" id="categories-list">
                                    <div class="categories-loading">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <p>Cargando categor√≠as...</p>
                </div>
            </div>
            
                                <div class="categories-footer-sidebar">
                                    <div class="categories-stats-sidebar">
                                        <span class="categories-count" id="categories-count">0 seleccionadas</span>
                                    </div>
                                    <button class="categories-apply-btn-sidebar" id="categories-apply-btn">
                                        <i class="fas fa-filter"></i>
                                        <span>Aplicar</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Estad√≠sticas de la Clasificaci√≥n Seleccionada -->
                        <div class="stats-section-sidebar">
                            <div class="stats-section-header">
                                <i class="fas fa-chart-pie"></i>
                                <h3 id="stats-section-title">Estad√≠sticas por Categor√≠a</h3>
                            </div>
                            
                            <div class="stats-grid-sidebar">
                                <div class="stat-card-sidebar">
                                    <div class="stat-icon-sidebar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <i class="fas fa-building"></i>
                                    </div>
                                    <div class="stat-info-sidebar">
                                        <div class="stat-label-sidebar">Total Proyectos</div>
                                        <div class="stat-value-sidebar" id="total-proyectos">0</div>
                                    </div>
                                </div>
                                
                                <div class="stat-card-sidebar success">
                                    <div class="stat-icon-sidebar" style="background: linear-gradient(135deg, #27AE60 0%, #229954 100%);">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="stat-info-sidebar">
                                        <div class="stat-label-sidebar">Exitosos</div>
                                        <div class="stat-value-sidebar" id="exitosos">0</div>
                                    </div>
                                </div>
                                
                                <div class="stat-card-sidebar moderate">
                                    <div class="stat-icon-sidebar" style="background: linear-gradient(135deg, #F39C12 0%, #E67E22 100%);">
                                        <i class="fas fa-exclamation-circle"></i>
                                    </div>
                                    <div class="stat-info-sidebar">
                                        <div class="stat-label-sidebar">Moderados</div>
                                        <div class="stat-value-sidebar" id="moderados">0</div>
                                    </div>
                                </div>
                                
                                <div class="stat-card-sidebar improve">
                                    <div class="stat-icon-sidebar" style="background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%);">
                                        <i class="fas fa-times-circle"></i>
                                    </div>
                                    <div class="stat-info-sidebar">
                                        <div class="stat-label-sidebar">Mejorables</div>
                                        <div class="stat-value-sidebar" id="mejorables">0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Lista de categor√≠as con colores y estad√≠sticas -->
                            <div class="category-stats-list" id="category-stats-list">
                                <div class="category-stats-header">
                                    <div class="category-stats-header-left">
                                        <i class="fas fa-list-ul"></i>
                                        <span>Distribuci√≥n por Categor√≠a</span>
                                    </div>
                                </div>
                                
                                <!-- Buscador y controles de ordenamiento -->
                                <div class="category-stats-controls">
                                    <div class="category-search-wrapper">
                                        <i class="fas fa-search"></i>
                                        <input type="text" id="category-stats-search" class="category-stats-search-input" placeholder="Buscar categor√≠a...">
                                        <button type="button" id="category-stats-search-clear" class="category-stats-search-clear" style="display: none;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div class="category-sort-wrapper">
                                        <label for="category-stats-sort" class="category-sort-label">
                                            <i class="fas fa-sort"></i>
                                            Ordenar:
                                        </label>
                                        <select id="category-stats-sort" class="category-stats-sort-select">
                                            <option value="name-asc">Nombre (A-Z)</option>
                                            <option value="name-desc">Nombre (Z-A)</option>
                                            <option value="count-asc">Cantidad (Menor)</option>
                                            <option value="count-desc" selected>Cantidad (Mayor)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="category-stats-table-wrapper">
                                    <table class="category-stats-table compact">
                                        <thead>
                                            <tr>
                                                <th class="th-color"><i class="fas fa-palette"></i></th>
                                                <th class="th-name">Categor√≠a</th>
                                                <th class="th-success"><i class="fas fa-check-circle"></i></th>
                                                <th class="th-moderate"><i class="fas fa-exclamation-circle"></i></th>
                                                <th class="th-improve"><i class="fas fa-times-circle"></i></th>
                                                <th class="th-count">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="category-stats-items">
                                            <!-- Se llenar√° din√°micamente -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="stats-chart-container-sidebar">
                                <div class="chart-title-sidebar">
                                    <i class="fas fa-chart-pie"></i> <span id="pie-chart-title">Distribuci√≥n por Categor√≠a</span>
                                </div>
                                <div class="pie-chart-wrapper-sidebar">
                                    <canvas id="pie-chart-canvas"></canvas>
                                    <div class="pie-chart-legend" id="pie-chart-legend"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
 <!-- Cierre de sidebar-content -->
        </aside>

    <!-- Contenedor principal -->
    <div class="container main-container">
        <!-- Contenido principal -->
        <main class="main-content">
            <!-- Mapa y Ranking de Constructores -->
            <div class="map-constructors-container">
                <!-- Mapa -->
                <div class="map-container">
                    <h3><i class="fas fa-map"></i> <span id="map-count">0</span> proyectos en el mapa</h3>
                    <div id="map">
                        <!-- Toolbar de controles del mapa -->
                        <div class="map-controls-toolbar" id="map-controls-toolbar" role="toolbar" aria-label="Controles del mapa">
                            <div class="toolbar-header">
                                <i class="fas fa-sliders-h"></i>
                                <span>Controles</span>
                                <button class="toolbar-toggle" id="toolbar-toggle" aria-label="Colapsar/Expandir toolbar" title="Colapsar">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>
                            
                            <div class="toolbar-content" id="toolbar-content">
                                <div class="map-control-group">
                                    <label for="map-style-select" class="map-control-label">
                                        <i class="fas fa-layer-group"></i>
                                        <span>Estilo de Mapa</span>
                                    </label>
                                    <div class="select-wrapper">
                                        <select id="map-style-select" class="map-control-select" aria-label="Seleccionar estilo de mapa">
                                            <option value="satellite">üõ∞Ô∏è Sat√©lite</option>
                                            <option value="streets">üõ£Ô∏è Calles</option>
                                            <option value="terrain">‚õ∞Ô∏è Terreno</option>
                                            <option value="light">‚òÄÔ∏è Claro</option>
                                            <option value="dark">üåô Oscuro</option>
                                        </select>
                                        <i class="fas fa-chevron-down select-arrow"></i>
                                    </div>
                                </div>
                                
                                <div class="map-control-group">
                                    <label for="marker-color-select" class="map-control-label">
                                        <i class="fas fa-palette"></i>
                                        <span>Color por</span>
                                    </label>
                                    <div class="select-wrapper">
                                        <select id="marker-color-select" class="map-control-select" aria-label="Seleccionar criterio de color para marcadores">
                                            <option value="clasificacion">üìä Clasificaci√≥n</option>
                                            <option value="vende">üë§ Vendedor</option>
                                            <option value="zona">üó∫Ô∏è Zona</option>
                                            <option value="barrio">üèòÔ∏è Barrio</option>
                                            <option value="estrato">üè¢ Estrato</option>
                                            <option value="tipo_vis">üè† Tipo VIS</option>
                                        </select>
                                        <i class="fas fa-chevron-down select-arrow"></i>
                                    </div>
                                </div>
                                
                                <div class="map-control-group">
                                    <button id="center-data-btn" class="map-control-btn" aria-label="Centrar mapa en todos los proyectos" title="Centrar datos">
                                        <i class="fas fa-crosshairs"></i>
                                        <span>Centrar Datos</span>
                                    </button>
                                </div>
                                
                                <div class="map-control-group">
                                    <button id="clear-filters-btn" class="map-control-btn" aria-label="Limpiar todos los filtros excepto Estado del Proyecto" title="Limpiar Filtros">
                                        <i class="fas fa-eraser"></i>
                                        <span>Limpiar Filtros</span>
                                    </button>
                                </div>
                                
                                <div class="toolbar-divider"></div>
                                
                                <div class="map-control-group">
                                    <span class="control-group-title">Capas</span>
                                    <div class="toggle-controls">
                                        <label class="map-control-checkbox-label">
                                            <input type="checkbox" id="cluster-toggle" class="map-control-checkbox" aria-checked="true" aria-label="Activar o desactivar agrupamiento de marcadores">
                                            <span class="checkbox-custom">
                                                <span class="checkbox-checkmark">
                                                    <i class="fas fa-check"></i>
                                                </span>
                                            </span>
                                            <span class="checkbox-label">
                                                <i class="fas fa-object-group"></i>
                                                <span>Cl√∫steres</span>
                                            </span>
                                        </label>
                                        
                                        <label class="map-control-checkbox-label">
                                            <input type="checkbox" id="heatmap-toggle" class="map-control-checkbox" aria-checked="false" aria-label="Activar o desactivar mapa de calor por precio">
                                            <span class="checkbox-custom">
                                                <span class="checkbox-checkmark">
                                                    <i class="fas fa-check"></i>
                                                </span>
                                            </span>
                                            <span class="checkbox-label">
                                                <i class="fas fa-fire"></i>
                                                <span>Mapa de Calor</span>
                                            </span>
                                        </label>
                                        
                                        <label class="map-control-checkbox-label">
                                            <input type="checkbox" id="markers-toggle" class="map-control-checkbox" aria-checked="true" aria-label="Activar o desactivar marcadores de proyectos">
                                            <span class="checkbox-custom">
                                                <span class="checkbox-checkmark">
                                                    <i class="fas fa-check"></i>
                                                </span>
                                            </span>
                                            <span class="checkbox-label">
                                                <i class="fas fa-map-marker-alt"></i>
                                                <span>Marcadores</span>
                                            </span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Leyenda del heatmap -->
                        <div class="heatmap-legend" id="heatmap-legend" style="display: none;" role="region" aria-label="Leyenda del mapa de calor">
                        <div class="heatmap-legend-header">
                            <strong>Precio (COP)</strong>
                        </div>
                        <div class="heatmap-legend-gradient">
                            <div class="heatmap-legend-item">
                                <span class="heatmap-legend-color" style="background: #2c7bb6;"></span>
                                <span class="heatmap-legend-text" id="heatmap-legend-low">Bajo</span>
                            </div>
                            <div class="heatmap-legend-item">
                                <span class="heatmap-legend-color" style="background: #ffffbf;"></span>
                                <span class="heatmap-legend-text" id="heatmap-legend-medium">Medio</span>
                            </div>
                            <div class="heatmap-legend-item">
                                <span class="heatmap-legend-color" style="background: #d7191c;"></span>
                                <span class="heatmap-legend-text" id="heatmap-legend-high">Alto</span>
                            </div>
                        </div>
                        <div class="heatmap-legend-bar">
                            <div class="heatmap-gradient-bar"></div>
                        </div>
                        <p class="heatmap-legend-note" style="font-size: 0.75rem; color: #666; margin-top: 0.5rem; text-align: center;">
                            Normalizaci√≥n: P5-P95
                        </p>
                    </div>
                    
                    </div> <!-- Cierre de #map -->
                </div>
                
                <!-- Panel de Vista Previa 360¬∞ -->
                <div class="street-preview-panel" id="street-preview-panel" style="display: none;" role="region" aria-label="Vista previa 360¬∞" aria-expanded="false">
                    <div class="street-preview-header">
                        <h3><i class="fas fa-street-view"></i> Vista Previa 360¬∞</h3>
                        <button class="street-preview-close" id="street-preview-close" aria-label="Cerrar vista previa" title="Cerrar">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="street-preview-content">
                        <!-- Contenedor del viewer de Mapillary -->
                        <div id="mly" style="height: 400px; display: none; border-radius: 8px; overflow: hidden; background: #000;"></div>
                        
                        <!-- Mensaje de carga -->
                        <div id="street-loading" style="display: none; padding: 2rem; text-align: center; color: #666;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>Cargando vista 360¬∞...</p>
                        </div>
                        
                        <!-- Mensaje sin cobertura -->
                        <div id="no360" style="display: none; padding: 1.5rem; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa;">
                            <p style="margin-bottom: 1rem; color: #666;">
                                <i class="fas fa-info-circle"></i> Sin cobertura 360¬∞ cercana para este proyecto.
                            </p>
                            <button id="btn-maps" class="btn-google-maps" aria-label="Abrir en Google Maps">
                                <i class="fab fa-google"></i> Abrir en Google Maps
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Ranking de Constructores -->
                <div class="constructors-panel">
                    <div class="constructors-header">
                        <h3><i class="fas fa-trophy"></i> Top 10 Constructores</h3>
                    </div>
                    <div class="constructors-content" id="constructors-ranking">
                        <div class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i> Cargando ranking...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs para Tabla y Caracter√≠sticas -->
            <div class="tabs-container">
                <div class="tabs-header">
                    <button class="tab-button active" data-tab="tabla">
                        <i class="fas fa-table"></i> Tabla de Proyectos
                        <span id="table-count" class="tab-count">(0)</span>
                    </button>
                    <button class="tab-button" data-tab="caracteristicas">
                        <i class="fas fa-chart-line"></i> Caracter√≠sticas Exitosos
                    </button>
                </div>
                
                <!-- Tab: Tabla de Proyectos -->
                <div class="tab-content active" id="tab-tabla">
                    <div class="table-container">
                        <div class="table-header-actions">
                            <h3><i class="fas fa-table"></i> Vista Previa de Datos</h3>
                            <button id="btn-descargar-csv" class="btn-download" title="Descargar todos los datos filtrados en CSV">
                                <i class="fas fa-download"></i> Descargar CSV
                            </button>
                        </div>
                        <div class="table-wrapper">
                            <table id="proyectos-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-column="codigo">
                                            <span>C√≥digo</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="nombre">
                                            <span>Proyecto</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="clasificacion">
                                            <span>Clasificaci√≥n</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="barrio">
                                            <span>Barrio</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="zona">
                                            <span>Zona</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="vende">
                                            <span>Vende</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="precio_promedio">
                                            <span>Precio Promedio</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="area_promedio">
                                            <span>√Årea (m¬≤)</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="velocidad_ventas">
                                            <span>Velocidad Ventas</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="unidades_vendidas">
                                            <span>Unid. Vendidas</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="unidades_disponibles">
                                            <span>Unid. Disponibles</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="score_exito">
                                            <span>Score √âxito</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="table-body">
                                    <tr>
                                        <td colspan="12" class="loading">Cargando datos...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Caracter√≠sticas de Proyectos Exitosos -->
                <div class="tab-content" id="tab-caracteristicas">
                    <div class="characteristics-container">
                        <div class="characteristics-header">
                            <h3><i class="fas fa-chart-line"></i> Caracter√≠sticas Comunes de Proyectos Exitosos</h3>
                            <p class="characteristics-subtitle">An√°lisis de patrones y caracter√≠sticas que comparten los proyectos clasificados como exitosos</p>
                        </div>
                        <div class="characteristics-content" id="caracteristicas-exitosos">
                            <div class="loading-state">
                                <i class="fas fa-spinner fa-spin"></i> Cargando caracter√≠sticas...
                            </div>
                        </div>
                        <!-- Mapa de Calor de Correlaciones -->
                        <div class="heatmap-container" id="correlation-heatmap-container" style="display: none;">
                            <div class="heatmap-header">
                                <h4><i class="fas fa-project-diagram"></i> Mapa de Calor de Correlaciones con √âxito del Proyecto</h4>
                                <p class="heatmap-subtitle">An√°lisis de correlaci√≥n entre variables originales del proyecto y su √©xito. Los colores indican la fuerza y direcci√≥n de la correlaci√≥n (rojo=positiva fuerte, azul=negativa fuerte).</p>
                            </div>
                            <div class="heatmap-wrapper">
                                <canvas id="correlation-heatmap"></canvas>
                            </div>
                            <div class="heatmap-legend-info" id="correlation-heatmap-legend-info"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Cargando datos...</p>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <!-- Leaflet Heat JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.min.js"></script>
    
    <!-- Configuraci√≥n de Mapillary Token (debe estar antes de street-preview.js) -->
    <script>
        // Token de Mapillary - puede ser configurado desde el servidor
        window.MAPILLARY_TOKEN = '{{ mapillary_token|default("MLY|YOUR_TOKEN_HERE") }}';
    </script>
    
    <!-- M√≥dulo de vista previa 360¬∞ -->
    <script src="{{ url_for('static', filename='js/street-preview.js') }}"></script>
    
    <!-- JavaScript personalizado -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    
    <!-- Test directo del panel (fallback) -->
    <script>
        // Test directo despu√©s de que todo cargue
        window.addEventListener('load', function() {
            console.log('[TEST] Verificando elementos del panel...');
            const panel = document.getElementById('sidebar');
            const toggle = document.getElementById('togglePanelBtn');
            const backdrop = document.getElementById('panelBackdrop');
            
            console.log('[TEST] Elementos encontrados:', {
                panel: !!panel,
                toggle: !!toggle,
                backdrop: !!backdrop,
                panelElement: panel,
                toggleElement: toggle
            });
            
            if (toggle && panel) {
                // Agregar listener directo como √∫ltimo recurso con toggle completo
                toggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[TEST] Click detectado en toggle!');
                    console.log('[TEST] Panel abierto actualmente:', panel.classList.contains('is-open'));
                    
                    const isOpen = panel.classList.contains('is-open');
                    
                    if (isOpen) {
                        // CERRAR panel
                        console.log('[TEST] Cerrando panel...');
                        const currentWidth = panel.offsetWidth || parseInt(localStorage.getItem('sidebarWidth')) || 529;
                        panel.style.cssText = `
                            position: fixed !important;
                            left: 0 !important;
                            top: 0 !important;
                            bottom: 0 !important;
                            width: ${currentWidth}px !important;
                            min-width: 280px !important;
                            max-width: 90vw !important;
                            height: 100vh !important;
                            transform: translateX(-100%) !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                            display: flex !important;
                            z-index: 10000 !important;
                        `;
                        panel.classList.remove('is-open');
                        panel.setAttribute('aria-hidden', 'true');
                        toggle.setAttribute('aria-expanded', 'false');
                        toggle.setAttribute('title', 'Expandir Panel');
                        document.body.classList.remove('panel-open');
                        console.log('[TEST] Panel cerrado');
                    } else {
                        // ABRIR panel
                        console.log('[TEST] Abriendo panel...');
                        const currentWidth = panel.offsetWidth || parseInt(localStorage.getItem('sidebarWidth')) || 529;
                        // Usar setProperty en lugar de cssText para permitir redimensionamiento
                        panel.style.setProperty('position', 'fixed', 'important');
                        panel.style.setProperty('left', '0', 'important');
                        panel.style.setProperty('top', '0', 'important');
                        panel.style.setProperty('bottom', '0', 'important');
                        panel.style.setProperty('height', '100vh', 'important');
                        panel.style.setProperty('transform', 'translateX(0)', 'important');
                        panel.style.setProperty('visibility', 'visible', 'important');
                        panel.style.setProperty('opacity', '1', 'important');
                        panel.style.setProperty('display', 'flex', 'important');
                        panel.style.setProperty('z-index', '10000', 'important');
                        panel.style.setProperty('background', 'white', 'important');
                        panel.style.setProperty('min-width', '280px', 'important');
                        panel.style.setProperty('max-width', '90vw', 'important');
                        panel.style.setProperty('width', currentWidth + 'px', 'important');
                        panel.classList.add('is-open');
                        panel.setAttribute('aria-hidden', 'false');
                        toggle.setAttribute('aria-expanded', 'true');
                        toggle.setAttribute('title', 'Ocultar Panel');
                        document.body.classList.add('panel-open');
                        console.log('[TEST] Panel abierto');
                    }
                });
                
                console.log('[TEST] Listener agregado al bot√≥n toggle (con toggle completo)');
            } else {
                console.error('[TEST] ERROR: No se encontraron elementos necesarios');
            }
        });
    </script>
    <!-- GeoMapval Chat Widget -->
    <script src="{{ url_for('static', filename='js/geomapval-chat.js') }}"></script>
    <script>
        // Inicializar el chat widget cuando la p√°gina est√© lista
        // Conectado con el backend de GeoMapval/Gemini API
        (function() {
            function initChatWidget() {
                // Esperar un momento para asegurar que el script se carg√≥
                setTimeout(function() {
                    // Verificar que la clase est√© disponible
                    if (typeof GeoMapvalChatWidget === 'undefined') {
                        console.error('[GeoMapval Chat] ERROR: GeoMapvalChatWidget no est√° definido. Verifica que el script se carg√≥ correctamente.');
                        // Reintentar despu√©s de 1 segundo
                        setTimeout(initChatWidget, 1000);
                        return;
                    }
                    
                    // Verificar que no se haya inicializado ya
                    if (window.geomapvalChat) {
                        console.log('[GeoMapval Chat] El widget ya est√° inicializado');
                        return;
                    }
                    
                    console.log('[GeoMapval Chat] Inicializando widget con conexi√≥n al backend...');
                    
                    try {
                        window.geomapvalChat = new GeoMapvalChatWidget({
                            onSendMessage: async function(message) {
                                try {
                                    console.log('[GeoMapval Chat] Enviando mensaje al backend:', message);
                                    
                                    const response = await fetch('/api/chat', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({ message: message })
                                    });
                                    
                                    console.log('[GeoMapval Chat] Respuesta recibida, status:', response.status);
                                    
                                    if (!response.ok) {
                                        const errorText = await response.text();
                                        console.error('[GeoMapval Chat] Error en respuesta:', errorText);
                                        throw new Error(`HTTP error! status: ${response.status}`);
                                    }
                                    
                                    const data = await response.json();
                                    console.log('[GeoMapval Chat] Datos recibidos:', data);
                                    
                                    // Manejar respuesta exitosa o con error
                                    if (data.success && data.response) {
                                        return data.response;
                                    } else if (data.response) {
                                        return data.response; // Aunque success sea false, mostrar el mensaje
                                    } else if (data.error) {
                                        return data.error;
                                    } else {
                                        return 'No se recibi√≥ respuesta del servidor.';
                                    }
                                } catch (error) {
                                    console.error('[GeoMapval Chat] Error al enviar mensaje:', error);
                                    return 'Error al conectar con el servidor. Por favor, verifica tu conexi√≥n e intenta nuevamente.';
                                }
                            }
                        });
                        
                        console.log('[GeoMapval Chat] Widget inicializado correctamente');
                        console.log('[GeoMapval Chat] onSendMessage configurado:', typeof window.geomapvalChat.onSendMessage);
                    } catch (error) {
                        console.error('[GeoMapval Chat] Error al inicializar widget:', error);
                    }
                }, 100); // Peque√±o delay para asegurar que el script se carg√≥
            }
            
            // Inicializar cuando el DOM est√© listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initChatWidget);
            } else {
                // DOM ya est√° listo
                initChatWidget();
            }
        })();
    </script>
</body>
</html>

