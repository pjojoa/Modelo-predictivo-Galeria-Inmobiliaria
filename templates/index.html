<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Proyectos Inmobiliarios - Cali</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <!-- Leaflet Heat CSS (no hay CSS específico, se incluye en JS) -->
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CSS personalizado -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <div class="container">
            <h1><i class="fas fa-map-marked-alt"></i> Mapa Interactivo de Proyectos Inmobiliarios</h1>
            <p><i class="fas fa-map-marker-alt"></i> Cali, Colombia</p>
        </div>
    </header>

    <!-- Contenedor principal -->
    <div class="container main-container">
        <!-- Sidebar de filtros -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-filter"></i> Filtros</h2>
                <div class="sidebar-controls">
                    <button class="sidebar-toggle" id="sidebar-toggle" title="Colapsar/Expandir">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="sidebar-resize" id="sidebar-resize" title="Cambiar ancho">
                        <i class="fas fa-arrows-alt-h"></i>
                    </button>
                </div>
            </div>
            <div class="sidebar-content" id="sidebar-content">
            
            <div class="filter-section">
                <label for="clasificacion">Clasificación</label>
                <select id="clasificacion" class="filter-select">
                    <option value="Todos">Todos</option>
                </select>
            </div>
            
            <div class="filter-section">
                <label for="zona">Zona</label>
                <select id="zona" class="filter-select">
                    <option value="Todas">Todas</option>
                </select>
            </div>
            
            <div class="filter-section">
                <label for="barrio">Barrio</label>
                <select id="barrio" class="filter-select">
                    <option value="Todos">Todos</option>
                </select>
            </div>
            
            <div class="filter-section">
                <label for="tipo_vis">Tipo VIS</label>
                <select id="tipo_vis" class="filter-select">
                    <option value="Todos">Todos</option>
                </select>
            </div>
            
            <div class="filter-section">
                <label for="estado">Estado del Proyecto</label>
                <select id="estado" class="filter-select">
                    <option value="Activos" selected>Activos</option>
                    <option value="Todos">Todos</option>
                    <option value="Inactivos">Inactivos</option>
                </select>
            </div>
            
            <div class="filter-section">
                <label for="precio_range">Rango de Precio (COP)</label>
                <div class="price-range">
                    <div class="price-input-group">
                        <label for="precio_min" class="price-label">Mínimo</label>
                        <input type="number" id="precio_min" class="price-input" placeholder="Mínimo" min="0" step="100000">
                    </div>
                    <span class="price-separator">-</span>
                    <div class="price-input-group">
                        <label for="precio_max" class="price-label">Máximo</label>
                        <input type="number" id="precio_max" class="price-input" placeholder="Máximo" min="0" step="100000">
                    </div>
                </div>
                <div class="price-range-info">
                    <small id="precio_range_info" class="price-info-text">Rango completo disponible</small>
                </div>
                <div class="price-buttons">
                    <button id="aplicar_precio" class="btn-apply">Aplicar Filtro</button>
                    <button id="limpiar_precio" class="btn-clear">Limpiar</button>
                </div>
            </div>
            
            <div class="sidebar-stats">
                <h3><i class="fas fa-chart-pie"></i> Estadísticas</h3>
                <div class="stat-item">
                    <span class="stat-label">Total Proyectos</span>
                    <span class="stat-value" id="total-proyectos">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Exitosos</span>
                    <span class="stat-value" id="exitosos">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Moderados</span>
                    <span class="stat-value" id="moderados">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Mejorables</span>
                    <span class="stat-value" id="mejorables">0</span>
                </div>
            </div>
            
            <div class="sidebar-info">
                <details>
                    <summary><i class="fas fa-question-circle"></i> ¿Cómo se clasifican los proyectos?</summary>
                    <div class="info-content">
                        <h4>Sistema de Clasificación de Proyectos</h4>
                        
                        <p>Los proyectos se clasifican en tres categorías basándose en múltiples métricas y un modelo de Machine Learning avanzado:</p>
                        
                        <div class="classification-detail">
                            <h5><i class="fas fa-check-circle" style="color: #27AE60;"></i> Exitosos</h5>
                            <ul>
                                <li><strong>Score de Éxito:</strong> 0.62 - 0.79</li>
                                <li><strong>Velocidad de ventas:</strong> Alta (típicamente 22+ unidades/mes)</li>
                                <li><strong>Meses para agotar:</strong> Menos de 18 meses</li>
                                <li><strong>Características:</strong> Proyectos con excelente desempeño, alta demanda y rápida rotación de inventario</li>
                            </ul>
                        </div>
                        
                        <div class="classification-detail">
                            <h5><i class="fas fa-exclamation-circle" style="color: #F39C12;"></i> Moderados</h5>
                            <ul>
                                <li><strong>Score de Éxito:</strong> 0.50 - 0.62</li>
                                <li><strong>Velocidad de ventas:</strong> Media (típicamente 8-22 unidades/mes)</li>
                                <li><strong>Meses para agotar:</strong> 18 - 36 meses</li>
                                <li><strong>Características:</strong> Proyectos con desempeño estándar, ventas constantes pero no excepcionales</li>
                            </ul>
                        </div>
                        
                        <div class="classification-detail">
                            <h5><i class="fas fa-times-circle" style="color: #E74C3C;"></i> Mejorables</h5>
                            <ul>
                                <li><strong>Score de Éxito:</strong> 0.21 - 0.50</li>
                                <li><strong>Velocidad de ventas:</strong> Baja (menos de 8 unidades/mes)</li>
                                <li><strong>Meses para agotar:</strong> Más de 36 meses</li>
                                <li><strong>Características:</strong> Proyectos que requieren atención, con bajas ventas y necesidad de estrategias de mejora</li>
                            </ul>
                        </div>
                        
                        <h5>Factores Considerados en la Clasificación:</h5>
                        <ul class="factors-list">
                            <li><strong>Tiempo de agotamiento (30%):</strong> Meses estimados para vender el inventario disponible</li>
                            <li><strong>Velocidad de ventas (18%):</strong> Unidades vendidas por mes</li>
                            <li><strong>Penetración de mercado (12%):</strong> Porcentaje de unidades vendidas vs. total</li>
                            <li><strong>Antigüedad y eficiencia temporal (10%):</strong> Tiempo objetivo de 24 meses (2 años) para cerrar un proyecto exitoso. Proyectos que cerraron en menos de 24 meses reciben score alto. Proyectos inactivos (ya vendidos) usan solo el tiempo desde inicio. Proyectos activos usan tiempo desde inicio + tiempo para agotar.</li>
                            <li><strong>Tamaño del proyecto (7%):</strong> Número de unidades (óptimo: 50-150 unidades)</li>
                            <li><strong>Precio por m² (7%):</strong> Posición competitiva dentro del segmento (zona/estrato)</li>
                            <li><strong>Área promedio (5%):</strong> Área de los inmuebles (óptimo: 60-100 m²)</li>
                            <li><strong>Características inmuebles (4%):</strong> Alcobas (2-3), Baños (2-3), Garajes (1-2)</li>
                            <li><strong>Amenidades (3%):</strong> Número y tipo de amenidades en zonas comunes</li>
                            <li><strong>Patrón de ventas (2%):</strong> Acelerado, Constante o Desacelerado</li>
                            <li><strong>Segmentación:</strong> Clasificación por Zona, Estrato y Tipo VIS para comparaciones justas</li>
                            <li><strong>Modelo ML:</strong> RandomForest Regressor para predecir meses de agotamiento</li>
                        </ul>
                        
                        <div class="classification-detail" style="margin-top: 1rem; background: #FFF3CD; padding: 1rem; border-radius: 8px; border-left: 4px solid #FFC107;">
                            <h5><i class="fas fa-clock"></i> Factor de Antigüedad y Eficiencia Temporal:</h5>
                            <p><strong>Tiempo Objetivo:</strong> 24 meses (2 años) para cerrar un proyecto exitoso desde su fecha de inicio.</p>
                            <p>Los proyectos se evalúan según su eficiencia temporal:</p>
                            <ul>
                                <li><strong>Proyectos que cerraron en ≤24 meses:</strong> Excelente desempeño (score alto: 0.7-1.0)</li>
                                <li><strong>Proyectos que cerraron en 24-36 meses:</strong> Aceptable (score medio-alto: 0.5-0.7)</li>
                                <li><strong>Proyectos que cerraron/tomarán 36-48 meses:</strong> Problemático (score medio: 0.3-0.5)</li>
                                <li><strong>Proyectos que tomarán >48 meses:</strong> Muy problemático (score bajo: 0.1-0.3)</li>
                                <li><strong>Proyectos inactivos:</strong> Si ya se vendió todo (Unidades_Disponibles = 0), el tiempo de cierre es solo el tiempo desde inicio hasta que se vendió todo</li>
                                <li><strong>Proyectos activos:</strong> El tiempo de cierre se calcula como: meses desde inicio + meses para agotar inventario</li>
                                <li><strong>Penalización adicional:</strong> Proyectos activos con más de 2 años desde inicio y menos del 50% vendido reciben penalización adicional</li>
                            </ul>
                            <p><strong>Ejemplo:</strong> Un proyecto que lleva 5 años activo y solo ha vendido el 50% de sus unidades claramente tiene problemas de flujo de caja y no es exitoso, aunque tenga buenas ventas recientes.</p>
                        </div>
                        
                        <div class="classification-detail" style="margin-top: 1rem;">
                            <h5>Método de Clasificación:</h5>
                            <p>La clasificación utiliza un <strong>Score Compuesto Ponderado</strong> que combina todas las variables anteriores. Los proyectos se comparan dentro de su segmento (misma Zona, Estrato y Tipo VIS) para asegurar comparaciones justas.</p>
                            <p><strong>Rangos de Clasificación:</strong></p>
                            <ul>
                                <li><strong>Exitoso:</strong> Score 0.62 - 0.79 (≥67% del score compuesto)</li>
                                <li><strong>Moderado:</strong> Score 0.50 - 0.62 (33% - 67% del score compuesto)</li>
                                <li><strong>Mejorable:</strong> Score 0.21 - 0.50 (<33% del score compuesto)</li>
                            </ul>
                        </div>
                        
                        <p><strong>Nota:</strong> La clasificación se realiza por segmentos (Zona/Estrato/Tipo VIS) para asegurar comparaciones justas entre proyectos similares. Las amenidades se extraen de la columna "Otros" separadas por comas.</p>
                    </div>
                </details>
            </div>
            </div> <!-- Cierre de sidebar-content -->
        </aside>

        <!-- Contenido principal -->
        <main class="main-content">
            <!-- Sección de información -->
            <div class="info-section">
                <div class="info-header">
                    <h2><i class="fas fa-chart-line"></i> Visualización de proyectos clasificados por desempeño</h2>
                    <button class="info-toggle" id="info-toggle">
                        <i class="fas fa-info-circle"></i> Información
                    </button>
                </div>
                
                <div class="info-panel" id="info-panel" style="display: none;">
                    <h3><i class="fas fa-chart-bar"></i> Método de Clasificación de Proyectos</h3>
                    <p>Los proyectos se clasifican mediante un <strong>Score de Éxito</strong> que combina múltiples métricas de desempeño.</p>
                    
                    <div class="classification-cards">
                        <div class="card-success">
                            <h4><i class="fas fa-check-circle"></i> PROYECTOS EXITOSOS</h4>
                            <p><strong>Score:</strong> 0.62-0.79 (promedio: 0.68)</p>
                            <p><strong>Velocidad:</strong> Alta - 22+ unidades/mes</p>
                            <p><strong>Patrón:</strong> Acelerado o Constante</p>
                        </div>
                        
                        <div class="card-moderate">
                            <h4><i class="fas fa-exclamation-circle"></i> PROYECTOS MODERADOS</h4>
                            <p><strong>Score:</strong> 0.50-0.62 (promedio: 0.55)</p>
                            <p><strong>Velocidad:</strong> Media - 8-9 unidades/mes</p>
                            <p><strong>Patrón:</strong> Constante o Desacelerado</p>
                        </div>
                        
                        <div class="card-improve">
                            <h4><i class="fas fa-times-circle"></i> PROYECTOS MEJORABLES</h4>
                            <p><strong>Score:</strong> 0.21-0.50 (promedio: 0.44)</p>
                            <p><strong>Velocidad:</strong> Baja o decreciente</p>
                            <p><strong>Patrón:</strong> Constante o Desacelerado</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Métricas principales -->
            <div class="metrics-grid">
                <div class="metric-card metric-success">
                    <div class="metric-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="metric-label">Exitosos</div>
                    <div class="metric-value" id="metric-exitosos">0</div>
                </div>
                <div class="metric-card metric-moderate">
                    <div class="metric-icon"><i class="fas fa-exclamation-circle"></i></div>
                    <div class="metric-label">Moderados</div>
                    <div class="metric-value" id="metric-moderados">0</div>
                </div>
                <div class="metric-card metric-improve">
                    <div class="metric-icon"><i class="fas fa-times-circle"></i></div>
                    <div class="metric-label">Mejorables</div>
                    <div class="metric-value" id="metric-mejorables">0</div>
                </div>
                <div class="metric-card metric-score">
                    <div class="metric-icon"><i class="fas fa-star"></i></div>
                    <div class="metric-label">Score Promedio</div>
                    <div class="metric-value" id="metric-score">0.00</div>
                </div>
            </div>

            <!-- Mapa y Ranking de Constructores -->
            <div class="map-constructors-container">
                <!-- Mapa -->
                <div class="map-container">
                    <h3><i class="fas fa-map"></i> <span id="map-count">0</span> proyectos en el mapa</h3>
                    <div id="map">
                        <!-- Toolbar de controles del mapa -->
                        <div class="map-controls-toolbar" id="map-controls-toolbar" role="toolbar" aria-label="Controles del mapa">
                        <div class="map-control-group">
                            <label for="map-style-select" class="map-control-label">
                                <i class="fas fa-layer-group"></i> Estilo
                            </label>
                            <select id="map-style-select" class="map-control-select" aria-label="Seleccionar estilo de mapa">
                                <option value="satellite">Satélite</option>
                                <option value="streets">Calles</option>
                                <option value="terrain">Terreno</option>
                                <option value="light">Claro</option>
                                <option value="dark">Oscuro</option>
                            </select>
                        </div>
                        
                        <div class="map-control-group">
                            <button id="center-data-btn" class="map-control-btn" aria-label="Centrar mapa en todos los proyectos" title="Centrar datos">
                                <i class="fas fa-crosshairs"></i> Centrar
                            </button>
                        </div>
                        
                        <div class="map-control-group">
                            <label class="map-control-checkbox-label">
                                <input type="checkbox" id="cluster-toggle" class="map-control-checkbox" aria-checked="true" aria-label="Activar o desactivar agrupamiento de marcadores">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Clústeres</span>
                            </label>
                        </div>
                        
                        <div class="map-control-group">
                            <label class="map-control-checkbox-label">
                                <input type="checkbox" id="heatmap-toggle" class="map-control-checkbox" aria-checked="false" aria-label="Activar o desactivar mapa de calor por precio">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Calor</span>
                            </label>
                        </div>
                        
                        <div class="map-control-group">
                            <label class="map-control-checkbox-label">
                                <input type="checkbox" id="markers-toggle" class="map-control-checkbox" aria-checked="true" aria-label="Activar o desactivar marcadores de proyectos">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Marcadores</span>
                            </label>
                        </div>
                        </div>
                        
                        <!-- Leyenda del heatmap -->
                        <div class="heatmap-legend" id="heatmap-legend" style="display: none;" role="region" aria-label="Leyenda del mapa de calor">
                        <div class="heatmap-legend-header">
                            <strong>Precio (COP)</strong>
                        </div>
                        <div class="heatmap-legend-gradient">
                            <div class="heatmap-legend-item">
                                <span class="heatmap-legend-color" style="background: #2c7bb6;"></span>
                                <span class="heatmap-legend-text" id="heatmap-legend-low">Bajo</span>
                            </div>
                            <div class="heatmap-legend-item">
                                <span class="heatmap-legend-color" style="background: #ffffbf;"></span>
                                <span class="heatmap-legend-text" id="heatmap-legend-medium">Medio</span>
                            </div>
                            <div class="heatmap-legend-item">
                                <span class="heatmap-legend-color" style="background: #d7191c;"></span>
                                <span class="heatmap-legend-text" id="heatmap-legend-high">Alto</span>
                            </div>
                        </div>
                        <div class="heatmap-legend-bar">
                            <div class="heatmap-gradient-bar"></div>
                        </div>
                        <p class="heatmap-legend-note" style="font-size: 0.75rem; color: #666; margin-top: 0.5rem; text-align: center;">
                            Normalización: P5-P95
                        </p>
                    </div>
                    </div> <!-- Cierre de #map -->
                </div>
                
                <!-- Ranking de Constructores -->
                <div class="constructors-panel">
                    <div class="constructors-header">
                        <h3><i class="fas fa-trophy"></i> Top 10 Constructores</h3>
                    </div>
                    <div class="constructors-content" id="constructors-ranking">
                        <div class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i> Cargando ranking...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs para Tabla y Características -->
            <div class="tabs-container">
                <div class="tabs-header">
                    <button class="tab-button active" data-tab="tabla">
                        <i class="fas fa-table"></i> Tabla de Proyectos
                        <span id="table-count" class="tab-count">(0)</span>
                    </button>
                    <button class="tab-button" data-tab="caracteristicas">
                        <i class="fas fa-chart-line"></i> Características Exitosos
                    </button>
                </div>
                
                <!-- Tab: Tabla de Proyectos -->
                <div class="tab-content active" id="tab-tabla">
                    <div class="table-container">
                        <div class="table-header-actions">
                            <h3><i class="fas fa-table"></i> Vista Previa de Datos</h3>
                            <button id="btn-descargar-csv" class="btn-download" title="Descargar todos los datos filtrados en CSV">
                                <i class="fas fa-download"></i> Descargar CSV
                            </button>
                        </div>
                        <div class="table-wrapper">
                            <table id="proyectos-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-column="codigo">
                                            <span>Código</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="nombre">
                                            <span>Proyecto</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="clasificacion">
                                            <span>Clasificación</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="barrio">
                                            <span>Barrio</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="zona">
                                            <span>Zona</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="vende">
                                            <span>Vende</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="precio_promedio">
                                            <span>Precio Promedio</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="area_promedio">
                                            <span>Área (m²)</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="velocidad_ventas">
                                            <span>Velocidad Ventas</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="unidades_vendidas">
                                            <span>Unid. Vendidas</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="unidades_disponibles">
                                            <span>Unid. Disponibles</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                        <th class="sortable" data-column="score_exito">
                                            <span>Score Éxito</span>
                                            <span class="sort-indicator"><i class="fas fa-sort"></i></span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="table-body">
                                    <tr>
                                        <td colspan="12" class="loading">Cargando datos...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Características de Proyectos Exitosos -->
                <div class="tab-content" id="tab-caracteristicas">
                    <div class="characteristics-container">
                        <div class="characteristics-header">
                            <h3><i class="fas fa-chart-line"></i> Características Comunes de Proyectos Exitosos</h3>
                            <p class="characteristics-subtitle">Análisis de patrones y características que comparten los proyectos clasificados como exitosos</p>
                        </div>
                        <div class="characteristics-content" id="caracteristicas-exitosos">
                            <div class="loading-state">
                                <i class="fas fa-spinner fa-spin"></i> Cargando características...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Cargando datos...</p>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <!-- Leaflet Heat JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.min.js"></script>
    
    <!-- JavaScript personalizado -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>

